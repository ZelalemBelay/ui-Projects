name: Setup HTTPS ON AWS-EC2 Remote Docker Host

on:
  workflow_dispatch:

jobs:
  setup-nginx-https:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo -e "Host *\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

      - name: Setup NGINX & HTTPS on Remote AWS EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_REMOTE_USER }}@${{ secrets.AWS_REMOTE_HOST }} << 'EOF'
          set -e

          DOMAIN="voltacores.com"
          EMAIL="zeelosoft@gmail.com"

          echo "ðŸ”§ Updating system and installing NGINX..."
          sudo yum update -y
          sudo amazon-linux-extras install nginx1 -y

          echo "ðŸš€ Starting NGINX..."
          sudo systemctl enable nginx
          sudo systemctl start nginx

          echo "ðŸŒ Installing Certbot..."
          sudo yum install -y certbot python3-certbot-nginx

          echo "ðŸ“ Writing NGINX reverse proxy config..."
          sudo tee /etc/nginx/conf.d/angular.conf > /dev/null <<EOL
          server {
              listen 80;
              server_name \$DOMAIN;
              return 301 https://\$host\$request_uri;
          }

          server {
              listen 443 ssl;
              server_name \$DOMAIN;

              ssl_certificate /etc/letsencrypt/live/\$DOMAIN/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/\$DOMAIN/privkey.pem;

              location / {
                  proxy_pass http://localhost:4200;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_cache_bypass \$http_upgrade;
              }
          }
          EOL

          echo "ðŸ” Testing NGINX config..."
          sudo nginx -t && sudo systemctl reload nginx

          echo "ðŸ”’ Requesting SSL certificate from Let's Encrypt..."
          sudo certbot --nginx --non-interactive --agree-tos -m \$EMAIL -d \$DOMAIN

          echo "ðŸ” Reloading NGINX with SSL..."
          sudo systemctl reload nginx

          echo "âœ… HTTPS setup complete at https://\$DOMAIN"
          EOF